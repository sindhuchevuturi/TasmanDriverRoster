<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Roster with Dynamic Inputs and Excel Download</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script> <!-- SheetJS Library -->
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            margin: 0;
        }
        .logo {
            width: 200px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input, select {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        .download-btn, .add-btn {
            margin: 20px 0;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
        .confirm-btn {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
        }
        .confirm-btn:disabled {
            background-color: grey;
            cursor: not-allowed;
        }
        .inactive-row {
            pointer-events: none;
            opacity: 0.6;
        }
        .confirmed-row {
            background-color: #f0f0f0;
            pointer-events: none;
        }
    </style>
</head>
<body>

<header>
    <h1>Driver Roster for <span id="currentDate"></span></h1>
    <img src="https://i.imgur.com/q4k13UQ.jpg" alt="Company Logo" class="logo">
</header>

<button class="download-btn" onclick="downloadExcel()">Download Everything as Excel</button>

<!-- Main Roster Table -->
<table id="rosterTable">
    <thead>
        <tr>
            <th>GEK #</th>
            <th>REGO</th>
            <th>TYPE</th>
            <th>Start Time</th>
            <th>Finish Time</th>
            <th>Service</th>
            <th>Driver</th>
            <th>Notes</th>
            <th>Confirm</th>
        </tr>
    </thead>
    <tbody id="rosterTableBody">
        <!-- Initial row will be generated here -->
    </tbody>
</table>

<!-- Drivers Tab -->
<h2>Drivers List</h2>
<table id="driversTable">
    <thead>
        <tr>
            <th>Driver Name</th>
            <th>On Leave</th>
            <th>Has MSIC</th>
            <th>Has White Card</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>(HC) Dean Piggot</td>
            <td><input type="checkbox" class="onLeave" onchange="populateDropDowns(currentRow)"></td>
            <td><input type="checkbox" class="hasMSIC" checked onchange="populateDropDowns(currentRow)"></td>
            <td><input type="checkbox" class="hasWhiteCard"></td>
        </tr>
        <tr>
            <td>(MC) Jagdip Singh</td>
            <td><input type="checkbox" class="onLeave" onchange="populateDropDowns(currentRow)"></td>
            <td><input type="checkbox" class="hasMSIC" onchange="populateDropDowns(currentRow)"></td>
            <td><input type="checkbox" class="hasWhiteCard"></td>
        </tr>
        <!-- Add more drivers -->
    </tbody>
</table>

<!-- Add New Driver -->
<input type="text" id="newDriverName" placeholder="Add New Driver Name">
<button class="add-btn" onclick="addDriver()">Add Driver</button>

<!-- Vehicles Tab -->
<h2>Vehicles List</h2>
<table id="vehiclesTable">
    <thead>
        <tr>
            <th>REGO</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>XW06PI</td>
        </tr>
        <tr>
            <td>XW48PI</td>
        </tr>
        <!-- Add more vehicles -->
    </tbody>
</table>

<!-- Add New Rego -->
<input type="text" id="newRego" placeholder="Add New Rego">
<button class="add-btn" onclick="addRego()">Add Rego</button>

<!-- Jobs Tab -->
<h2>Jobs List</h2>
<table id="jobsTable">
    <thead>
        <tr>
            <th>Client Name</th>
            <th>Wharf Location (Restricted)</th>
            <th>Type</th>
            <th>Confirm</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Sunrice</td>
            <td>No</td>
            <td>
                <select>
                    <option value="S">S</option>
                    <option value="SDL">SDL</option>
                    <option value="RT">RT</option>
                    <option value="BDBL">BDBL</option>
                </select>
            </td>
            <td><button class="confirm-btn" onclick="confirmJob(this)">Confirm</button></td>
        </tr>
        <tr>
            <td>Agripak</td>
            <td>No</td>
            <td>
                <select>
                    <option value="S">S</option>
                    <option value="SDL">SDL</option>
                    <option value="RT">RT</option>
                    <option value="BDBL">BDBL</option>
                </select>
            </td>
            <td><button class="confirm-btn" onclick="confirmJob(this)">Confirm</button></td>
        </tr>
        <tr>
            <td>CHS BB</td>
            <td>No</td>
            <td>
                <select>
                    <option value="S">S</option>
                    <option value="SDL">SDL</option>
                    <option value="RT">RT</option>
                    <option value="BDBL">BDBL</option>
                </select>
            </td>
            <td><button class="confirm-btn" onclick="confirmJob(this)">Confirm</button></td>
        </tr>
        <tr>
            <td>Wharf</td>
            <td>Yes</td>
            <td>
                <select>
                    <option value="S">S</option>
                    <option value="SDL">SDL</option>
                    <option value="RT">RT</option>
                    <option value="BDBL">BDBL</option>
                </select>
            </td>
            <td><button class="confirm-btn" onclick="confirmJob(this)">Confirm</button></td>
        </tr>
    </tbody>
</table>

<!-- Add New Job -->
<input type="text" id="newJob" placeholder="Add New Job">
<button class="add-btn" onclick="addJob()">Add Job</button>

<script>
    let currentRow = 1;
    let confirmedRowsCount = 0;
    let confirmedJobs = [];

    // Function to get current date based on Melbourne time
    function getMelbourneDate() {
        const now = new Date();
        const melbourneTime = now.toLocaleString('en-AU', {
            timeZone: 'Australia/Melbourne',
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
        document.getElementById("currentDate").innerText = melbourneTime;
    }

    // Function to dynamically add a new row after confirming the previous row
    function addRow() {
        const tableBody = document.getElementById('rosterTableBody');
        const rowId = currentRow;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>3072${rowId}</td>
            <td><select id="rego${rowId}"></select></td>
            <td>
                <select id="type${rowId}"></select>
            </td>
            <td><input type="time" id="startTime${rowId}"></td>
            <td><input type="time" id="finishTime${rowId}"></td>
            <td><select id="service${rowId}"></select></td>
            <td><select id="driver${rowId}"></select></td>
            <td><input type="text"></td>
            <td><button class="confirm-btn" onclick="confirmRow(${rowId})">Confirm</button></td>
        `;
        tableBody.appendChild(row);
        populateDropDowns(rowId);
    }

    // Function to confirm a job from the jobs list and move it to the roster table
    function confirmJob(button) {
        const row = button.closest('tr');
        const clientName = row.cells[0].textContent;
        const selectedType = row.cells[2].querySelector('select').value;

        // Add the confirmed job to the confirmedJobs array
        confirmedJobs.push({
            jobName: clientName,
            jobType: selectedType
        });

        // Disable the confirm button and dropdown to prevent re-confirmation
        button.disabled = true;
        row.cells[2].querySelector('select').disabled = true;

        // Refresh the dropdowns for the next row
        populateDropDowns(currentRow);
    }

    // Function to populate dropdowns from driver, vehicles, and jobs tabs
    function populateDropDowns(rowId) {
        const drivers = document.querySelectorAll('#driversTable tbody tr');
        const vehicles = document.querySelectorAll('#vehiclesTable tbody tr');
        const driverSelect = document.getElementById(`driver${rowId}`);
        const regoSelect = document.getElementById(`rego${rowId}`);
        const serviceSelect = document.getElementById(`service${rowId}`);
        const typeSelect = document.getElementById(`type${rowId}`);

        driverSelect.innerHTML = '';
        regoSelect.innerHTML = '';
        serviceSelect.innerHTML = '';
        typeSelect.innerHTML = '';

        // Populate vehicles dropdown
        vehicles.forEach(function (row) {
            const option = document.createElement('option');
            option.value = row.cells[0].textContent;
            option.textContent = row.cells[0].textContent;
            regoSelect.appendChild(option);
        });

        // Populate drivers dropdown, filter by "On Leave"
        drivers.forEach(function (row) {
            const driverName = row.cells[0].textContent;
            const onLeave = row.cells[1].querySelector('.onLeave').checked;
            const hasMSIC = row.cells[2].querySelector('.hasMSIC').checked;

            if (!onLeave) {
                const option = document.createElement('option');
                option.value = driverName;
                option.textContent = driverName;
                driverSelect.appendChild(option);

                // Filter services based on MSIC for wharf jobs
                serviceSelect.innerHTML = '';
                confirmedJobs.forEach(function (job) {
                    const isWharf = job.jobName === "Wharf";
                    if (!hasMSIC && isWharf) return; // Skip wharf jobs for non-MSIC drivers

                    const serviceOption = document.createElement('option');
                    serviceOption.value = job.jobName;
                    serviceOption.textContent = job.jobName;
                    serviceSelect.appendChild(serviceOption);

                    const typeOption = document.createElement('option');
                    typeOption.value = job.jobType;
                    typeOption.textContent = job.jobType;
                    typeSelect.appendChild(typeOption);
                });
            }
        });
    }

    // Function to confirm a row and dynamically add the next one
    function confirmRow(rowId) {
        const currentRowElement = document.querySelector(`#rosterTableBody tr:nth-child(${rowId})`);
        currentRowElement.classList.add('confirmed-row');
        currentRowElement.querySelector('.confirm-btn').disabled = true;

        confirmedRowsCount++;
        currentRow++;
        
        if (confirmedRowsCount < 1000) {
            addRow(); // Add the next row dynamically
        }
    }

    // Function to add a new driver dynamically
    function addDriver() {
        const newDriverName = document.getElementById('newDriverName').value.trim();
        if (newDriverName !== "") {
            const driversTable = document.getElementById('driversTable').querySelector('tbody');
            const newRow = driversTable.insertRow();

            newRow.innerHTML = `
                <td>${newDriverName}</td>
                <td><input type="checkbox" class="onLeave" onchange="populateDropDowns(currentRow)"></td>
                <td><input type="checkbox" class="hasMSIC" onchange="populateDropDowns(currentRow)"></td>
                <td><input type="checkbox" class="hasWhiteCard"></td>
            `;

            // Clear input and refresh dropdowns
            document.getElementById('newDriverName').value = '';
            populateDropDowns(currentRow);
        }
    }

    // Function to add a new vehicle (rego) dynamically
    function addRego() {
        const newRego = document.getElementById('newRego').value.trim();
        if (newRego !== "") {
            const vehiclesTable = document.getElementById('vehiclesTable').querySelector('tbody');
            const newRow = vehiclesTable.insertRow();
            newRow.innerHTML = `<td>${newRego}</td>`;

            // Clear input and refresh dropdowns
            document.getElementById('newRego').value = '';
            populateDropDowns(currentRow);
        }
    }

    // Function to add a new job dynamically
    function addJob() {
        const newJob = document.getElementById('newJob').value.trim();
        if (newJob !== "") {
            const jobsTable = document.getElementById('jobsTable').querySelector('tbody');
            const newRow = jobsTable.insertRow();
            newRow.innerHTML = `
                <td>${newJob}</td>
                <td>No</td>
                <td>
                    <select>
                        <option value="S">S</option>
                        <option value="SDL">SDL</option>
                        <option value="RT">RT</option>
                        <option value="BDBL">BDBL</option>
                    </select>
                </td>
                <td><button class="confirm-btn" onclick="confirmJob(this)">Confirm</button></td>
            `;

            // Clear input and refresh dropdowns
            document.getElementById('newJob').value = '';
        }
    }

    // Function to download the entire roster to an Excel file
    function downloadExcel() {
        const workbook = XLSX.utils.book_new();

        // Collect data from the roster table, drivers table, vehicles table, and jobs table
        const rosterData = tableToArray(document.getElementById('rosterTable'));
        const driversData = tableToArray(document.getElementById('driversTable'));
        const vehiclesData = tableToArray(document.getElementById('vehiclesTable'));
        const jobsData = tableToArray(document.getElementById('jobsTable'));

        // Create worksheets for each section
        const rosterSheet = XLSX.utils.aoa_to_sheet(rosterData);
        const driversSheet = XLSX.utils.aoa_to_sheet(driversData);
        const vehiclesSheet = XLSX.utils.aoa_to_sheet(vehiclesData);
        const jobsSheet = XLSX.utils.aoa_to_sheet(jobsData);

        // Add worksheets to the workbook
        XLSX.utils.book_append_sheet(workbook, rosterSheet, 'Roster');
        XLSX.utils.book_append_sheet(workbook, driversSheet, 'Drivers');
        XLSX.utils.book_append_sheet(workbook, vehiclesSheet, 'Vehicles');
        XLSX.utils.book_append_sheet(workbook, jobsSheet, 'Jobs');

        // Generate file name based on the date
        const dateString = new Date().toLocaleDateString('en-AU').replace(/\//g, '_');
        const fileName = `Driver_Roster_${dateString}.xlsx`;

        // Download the Excel file
        XLSX.writeFile(workbook, fileName);
    }

    // Utility function to convert table to a 2D array for Excel export
    function tableToArray(table) {
        const data = [];
        table.querySelectorAll('tr').forEach(row => {
            const rowData = [];
            row.querySelectorAll('th, td').forEach(cell => {
                const input = cell.querySelector('input, select');
                rowData.push(input ? (input.value || cell.textContent) : cell.textContent);
            });
            data.push(rowData);
        });
        return data;
    }

    // Initial setup: add the first row, populate dropdowns, and set the current date
    window.onload = function () {
        addRow(); // Add the first row
        getMelbourneDate(); // Set the current date in the header
    };
</script>

</body>
</html>
